"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loggerHandler = void 0;
const core_1 = require("@marblejs/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const logger_factory_1 = require("./logger.factory");
const logger_util_1 = require("./logger.util");
exports.loggerHandler = (opts, logger) => (stamp) => {
    const req = stamp.value;
    const res = req.response;
    return rxjs_1.fromEvent(res, 'finish').pipe(operators_1.take(1), operators_1.mapTo(req), operators_1.filter(logger_util_1.isNotSilent(opts)), operators_1.filter(logger_util_1.filterResponse(opts)), operators_1.map(logger_factory_1.factorizeLog(stamp)), operators_1.tap(message => {
        const level = res.statusCode >= 500
            ? core_1.LoggerLevel.ERROR
            : res.statusCode >= 400
                ? core_1.LoggerLevel.WARN
                : core_1.LoggerLevel.INFO;
        const log = logger({ tag: "http" /* HTTP */, type: 'RequestLogger', message, level });
        return log();
    }));
};
